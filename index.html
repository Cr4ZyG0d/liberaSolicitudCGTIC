<!DOCTYPE html>
<html>

<head>
    <title>Liberar Solicitud CGTIC</title>
    <meta charset="UTF-8">
    <link rel="icon" type="image/x-icon" href="./favicon.ico" />
    <link href="./reports.css" rel="stylesheet" type="text/css">
</head>

<body>
    <div class="row"
        style="background-image: url(./bg_header.png); background-repeat: no-repeat; background-size: cover">
        <div _ngcontent-sxm-c1="" class="col-4" style="padding-top: 15px; padding-bottom: 10px;">
            <img _ngcontent-sxm-c1="" alt="" src="./logo_2.png"
                style=" width:250px; " tabindex="0" ng-reflect-router-link="inicio">
        </div>
    </div>
    <div style="text-align: center;">
        <form id="login-form" style="margin: 0 auto; width: 50%;">
            <br /><label for="example-input" style="font-style: normal; font-weight: bold; font-size: 20px">Por favor
                ingrese sus datos</label></br>
            <input type="text" id="username" name="username" style="width: 200px; padding: 7px; margin: 10px;"
                placeholder="Usuario"><br />
            <input type="password" id="password" name="password" style="width: 200px; padding: 7px; margin: 10px;"
                placeholder="Contraseña"><br />
            <input type="submit" value="Iniciar sesión" id="btnSubmit"
                style="background-color: #0e53ea; border-color: #0e53ea; color: white; padding: 10px 20px; margin: 10px;"><br />
        </form>
        </form>
        <div id="error-message"></div>
    </div>
    <footer _ngcontent-sxm-c2=""
        style="linear-gradient(90deg, rgba(11,24,39,1) 0%, rgba(39,77,130,1) 35%, rgba(11,24,39,1) 100%);">
        <div _ngcontent-sxm-c2="" class="container-fluid bg_footer">
            <div _ngcontent-sxm-c2="" class="row">
                <div _ngcontent-sxm-c2="" class="col-12">
                    <div _ngcontent-sxm-c2="" style="float: right;  font-size: 10px; width: 100%; text-align: end;">
                        <a _ngcontent-sxm-c2="" style="text-decoration:none; padding-right: 5px !important;">Copyright
                            2023© DIRECCIÓN GENERAL DE
                            REGISTRO CIVIL, IDENTIFICACIÓN Y CEDULACIÓN</a>
                    </div>
                    <div _ngcontent-sxm-c2="" style="float: right; width: 100%;  font-size: 10px;">
                        <p _ngcontent-sxm-c2="" style="float: right;padding-right: 5px !important;">Versión 1.3</p>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <script>
        setInterval("location.reload()", 18000000);
        document.addEventListener("contextmenu", function (e) { e.preventDefault(); }, false);
        /**
         *
         * Obtiene MAC
         *
         */
        let globalData;
        async function getData() {
            try {
                const response = await fetch('http://localhost:8083/client/getMAC');
                globalData = await response.json();
            } catch (error) {
                console.error(error);
            }
        }

        /**
         *
         * Valida MAC
         *
         */
        let globalValid;
        async function useData() {
            await getData();
            var myHeaders = new Headers();
            myHeaders.append("Content-Type", "application/json");
            var dataUser = {};
            dataUser.mac = globalData;
            var raw = JSON.stringify(dataUser.mac);
            try {
                const response = await fetch('https://sedip.registrocivil.gob.ec:3005/configuracion/validaAccesoMACEquipoSedip', {
                    method: 'POST',
                    headers: myHeaders,
                    body: raw,
                    redirect: 'follow'
                });
                globalValid = await response.json();
            } catch (error) {
                console.error(error);
            }
        }

        /**
         *
         * Valida Respuesta de MAC
         *
         */
        let globalTest;
        async function checkValidacion() {
            await useData();
            if (globalValid.data) {
                await getToken();
            } else {
                alert("Dirección MAC no Registrada");
                document.getElementById('username').disabled = true;
                document.getElementById('password').disabled = true;
                document.getElementById('btnSubmit').disabled = true
            }
        }

        /**
         *
         * Recibe valores del formulacion de Login
         *
         */
        let globalToken;
        let usuario;
        let agencia;
        let resultFiler;
        async function getToken() {
            const form = document.getElementById('login-form');
            form.addEventListener('submit', async (event) => {
                event.preventDefault(); // evita el comportamiento por defecto del formulario
                usuario = document.getElementById('username').value;
                const clave = document.getElementById('password').value;
                const loginData = {
                    usuario: usuario,
                    clave: clave
                };
                try {
                    const response = await fetch('https://sedip.registrocivil.gob.ec:3005/sedip/getToken', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(loginData),
                        redirect: 'follow'
                    });
                    //Valida el Token generado con la petición anterior
                    globalToken = await response.json();
                    const validToken = await fetch('https://sedip.registrocivil.gob.ec:3005/sedip/validarToken', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(globalToken),
                        redirect: 'follow'
                    })
                    const respToken = await validToken.json();
                    if (respToken.code === 200) {
                        const responseLogin = await fetch('https://sedip.registrocivil.gob.ec:3005/sedip/LoginUsuario', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(loginData),
                            redirect: 'follow'
                        });
                        const dataLoginAll = await responseLogin.json();
                        if (dataLoginAll.usuario.codError === "000") {
                            await postLiberarSolicitud();
                        } else {
                            alert("Usuario/Contraseña Incorrectos")
                        }
                    }
                } catch (error) {
                    console.error(error)
                }
            });
        }

        /**
         *
         * Libera la solicitud de la cola de impresión
         *
         */
        let respEnviaSol;
        let listadoSolicitudes = [];
        async function postLiberarSolicitud() {
            await getToken();
            // HEADER
            document.write('<title>Liberar Solicitud CGTIC</title>')
            document.write('<link href="./reports.css" rel="stylesheet" type="text/css">');
            document.write('<div class="row" style="background-image: url(./bg_header.png); background-repeat: no-repeat; background-size: cover">');
            document.write('<div _ngcontent-sxm-c1="" class="col-4" style="padding-top: 15px; padding-bottom: 10px;">');
            document.write('<img _ngcontent-sxm-c1="" alt="" src="./logo_2.png" style=" width:250px; " tabindex="0" ng-reflect-router-link="inicio">');
            document.write('</div></div>');
            // DATOS
            document.write('<div style="text-align: center;">')
            document.write('<br/><label for="example-input" style="font-style: normal; font-weight: bold; font-size: 20px">Solicitud a liberar CGTIC</label></br>');
            document.write('<input type="number" id="example-input" name="example-input" pattern="[0-9]{8}" style="width: 200px; padding: 7px; margin: 10px;" required>');
            document.write('<button type="submit" id="submit-button" name="submit-button" style="background-color: #0e53ea; border-color: #0e53ea; blue; color: white; padding: 10px 20px; margin: 10px;">LIBERAR</button></br>');
            document.write('<button id="load-data-button" style="background-color: #0e53ea; border-color: #0e53ea; blue; color: white; padding: 10px 20px; margin: 10px;">Liberar con TXT</button></div>');
            // FOOTER
            document.write('<br/><footer _ngcontent-sxm-c2="" style="linear-gradient(to right,#0B1827,#274D82,#0B1827);">');
            document.write('<div _ngcontent-sxm-c2="" class="container-fluid bg_footer">');
            document.write('<div _ngcontent-sxm-c2="" class="row">');
            document.write('<div _ngcontent-sxm-c2="" class="col-12">');
            document.write('<div _ngcontent-sxm-c2="" style="float: right;  font-size: 10px; width: 100%; text-align: end;">');
            document.write('<a _ngcontent-sxm-c2="" style="text-decoration:none; padding-right: 5px !important;">Copyright 2023© DIRECCIÓN GENERAL DE REGISTRO CIVIL, IDENTIFICACIÓN Y CEDULACIÓN</a></div>');
            document.write('<div _ngcontent-sxm-c2="" style="float: right; width: 100%;  font-size: 10px; padding-right: 5px !important;">');
            document.write('<p _ngcontent-sxm-c2="" style="float: right; padding-right: 5px !important;">Versión 1.2</p>');
            document.write('</div></div></div></div></footer>');
            document.addEventListener("contextmenu", function (e) { e.preventDefault(); }, false);
            const button = document.getElementById("submit-button");
            button.addEventListener("click", async (e) => {
                e.preventDefault();
                const solicitud = document.getElementById('example-input').value;
                let dataSol = {};
                dataSol.operador = usuario;
                dataSol.solicitudes = [];
                let value = solicitud;
                let numericRegex = /^[0-9]+$/;
                if (numericRegex.test(value) && value.length == 8) {
                    dataSol.solicitudes.push(value)
                    try {
                        const response = await fetch('https://sedip.registrocivil.gob.ec:3005/configuracion/eliminaSolicitudesCSV', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': '"' + globalToken.token + '"'
                            },
                            body: JSON.stringify(dataSol),
                            redirect: 'follow'
                        });
                        respEnviaSol = await response.json();
                        if (respEnviaSol.data == "Eliminadas" && respEnviaSol.res1 == 1) {
                            alert("La solicitud " + solicitud + " fue Liberada")
                        } else if (respEnviaSol.res2 == 1) {
                            alert("Solicitud " + solicitud + " no se encuentra en la cola de impresión")
                        }
                    } catch (error) {
                        console.error(error);
                        alert("No se pudo procesar")
                    }
                } else {
                    alert("Debe ser numérico y tener 8 caracteres")
                }
            });

            const loadDataButton = document.getElementById("load-data-button");

            loadDataButton.addEventListener("click", async function () {
                const fileInput = document.createElement("input");
                fileInput.type = "file";
                fileInput.accept = ".txt";

                let dataArray;
                fileInput.addEventListener("change", async function () {
                    const file = fileInput.files[0];
                    const data = await readTextFile(file);
                    dataArray = await data.split('\r\n');
                    let dataMasiva = {};
                    dataMasiva.operador = usuario;
                    dataMasiva.solicitudes = dataArray
                    try {
                        const response = await fetch('https://sedip.registrocivil.gob.ec:3005/configuracion/eliminaSolicitudesCSV', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': '"' + globalToken.token + '"'
                            },
                            body: JSON.stringify(dataMasiva),
                            redirect: 'follow'
                        });
                        respEnviaSol = await response.json();
                        if (respEnviaSol.data == "Eliminadas" && (respEnviaSol.res1 > 0 || respEnviaSol.res2 > 0)) {
                            alert(respEnviaSol.res1 + " Liberada(as), " + respEnviaSol.res2 + " Solicitudes no fueron encontradas en los registros de solicitudes de SEDIP.")
                        }
                    } catch (error) {
                        console.error(error);
                        alert("No se pudo procesar")
                    }
                });
                fileInput.click();
            });

            async function readTextFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();

                    reader.onload = function () {
                        resolve(reader.result);
                    };

                    reader.onerror = function (error) {
                        reject(error);
                    };

                    reader.readAsText(file);
                });
            }
        }
        checkValidacion();
    </script>

</body>

</html>
